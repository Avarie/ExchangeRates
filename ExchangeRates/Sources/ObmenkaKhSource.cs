using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using AngleSharp.Dom;
using AngleSharp.Html.Parser;
using ExchangeRates.Models;

namespace ExchangeRates.Sources
{
    public class ObmenkaKhSource : ICurrencyDataSource
    {
        private string ObmenkaRetail = Helpers.SourceListHelper.ObmenkaRetail;
        private string ObmenkaWholesale = Helpers.SourceListHelper.ObmenkaWholesale;
        private List<IElement> _elements = new List<IElement>();
        public List<CurrencyItem> GetSource()
        {
            var doc =
                "<!doctype html>\n<html>\n    <head>\n        <meta name=\"description\" content=\"Обмен валюты в Харькове в центре обмена obmenka.kh.ua по выгодному курсу. Самый выгодный и актуальный курс в Харькове. Курс валют и настоящий курс в режиме онлайн.\" />\n        <meta name=\"keywords\" content=\"обмен валюты Харьков, обмен валюты, выгодный курс обмена, центр обмена, курс обмена валюты, любые суммы, гибкий курс, выгодный курс обмена, центр обмена, курс обмена валюты, обмен валюты, конфиденциальность, Харьков\">\n        <meta name=\"copyright\" content=\"obmenka.kh.ua\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n        <link rel=\"icon\" href=\"/favicon.ico\" type=\"image/x-icon\">\n         <link rel=\"stylesheet\" href=\"css/animate.css\">\n        <link rel=\"stylesheet\" href=\"css/font.css\"><link rel=\"stylesheet\" href=\"css/styles.css\">\n        <title>Обмен валюты в Харькове. Самый выгодный курс в городе! обменка в Харькове</title>\n    </head>\n    <body>\n    <!-- Global site tag (gtag.js) - Google Analytics -->\n<script async src=\"https://www.googletagmanager.com/gtag/js?id=UA-154779118-1\"></script>\n<script>\n  window.dataLayer = window.dataLayer || [];\n  function gtag(){dataLayer.push(arguments);}\n  gtag('js', new Date());\n\n  gtag('config', 'UA-154779118-1');\n</script>\n\n        <div class=\"app\">\n            <header>\n                <div class=\"container\">\n                    <a class=\"logo fadeInDown animated \" title = \"Курс обмена валюты, обмен валюты Харьков\"  href=\"./\"><img src=\"./img/logo.png\" alt=\"Центр обмена obmenka.kh.ua - Любые суммы. Гибкий курс. Конфиденциальность.\" name=\"Центр обмена obmenka.kh.ua\"></a>\n                    <a href=\"tel:0966028040\" class=\"phone fadeInDown animated \">096-60-280-40</a>\n                    <a href=\"tel:0505759395\" class=\"phone fadeInDown animated \">050-57-59-395</a>\n                </div>\n            </header>\n                        <div class=\"dark\">\n                <div class=\"container\">\n                 <div class=\"telegram-block\">\n                    <a href=\"https://t.me/ObmenkaaKh\" target=\"_blank\" title=\"Telegram канал\">\n                        <img src=\"img/telegram.png\" width=\"30px\" height=\"30px\">\n                        <span>Telegram канал</span>\n                    </a>\n                </div>\n                <p class=\"date fadeInDown animated \">Актуальные курсы на 16.03.2020:</p>\n                                <p class=\"mini-alert fadeInDown animated\">Занимаемся обменом ветхих и рваных купюр с минимальным процентом!</p>\n                    <div class=\"tabs\">\n                         <ul class=\"tabs__caption switch fadeInRight animated\">\n                            <li class=\"active\">\n                            \t<buttom type=\"buttom\" class=\"buttom-switch\">\n                        \t\t\t\tОПТ\n                        \t\t</buttom>\n                        \t</li>\n                            <li>\n                            \t<buttom type=\"buttom\" class=\"buttom-switch\">\n                        \t\t РОЗНИЦА\n                        \t\t</buttom>\n                        \t</li>\n                          </ul>\n                          <div class=\"tabs__content active fadeInLeft animated\">\n                            \n                         <div class=\"tablo\">\n                          <p class=\"tablo-title\">ОПТ </p>\n                            <div class=\"bar\">\n                                <div class=\"clear\"></div>\n                                <div class=\"text\">\n                                    <span>Покупка</span>\n                                    <span>Продажа</span>\n                                </div>\n                            </div>\n                            <div class=\"digits\">\n                                <div class=\"item\">\n                                    <span class=\"val\">usd/uah</span>\n                                    <span class=\"buy\" name=\"usd_buy_wsale\">27.60 </span>\n                                    <span class=\"sell\" name=\"usd_sale_wsale\">27.95 </span>\n                                    <div class=\"shadow\"></div>\n                                </div>\n    \n                                <div class=\"item\">\n                                    <span class=\"val\">eur/uah</span>\n                                    <span class=\"buy\" name=\"eur_buy_wsale\">30.20 </span>\n                                    <span class=\"sell\" name=\"eur_sale_wsale\">30.80 </span>\n                                    <div class=\"shadow\"></div>\n                                </div>\n    \n                                <div class=\"item\">\n                                    <span class=\"val\">rub/uah</span>\n                                    <span class=\"buy\" name=\"rub_buy_wsale\">0.3650 </span>\n                                    <span class=\"sell\" name=\"rub_sale_wsale\">0.3750 </span>\n                                    <div class=\"shadow\"></div>\n                                </div>\n    \n                                <div class=\"item\">\n                                    <span class=\"val\">usd/rub</span>\n                                    <span class=\"buy\" name=\"usd_rub_buy_wsale\">73.500 </span>\n                                    <span class=\"sell\" name=\"usd_rub_sale_wsale\">75.200 </span>\n                                    <div class=\"shadow\"></div>\n                                </div>\n    \n                                <div class=\"item\">\n                                    <span class=\"val\">eur/usd</span>\n                                    <span class=\"buy\" name=\"eur_usd_buy_wsale\">1.103 </span>\n                                    <span class=\"sell\" name=\"eur_usd_sale_wsale\">1.112 </span>\n                                    <div class=\"shadow\"></div>\n                                </div>\n    \n                                <div class=\"item\">\n                                    <span class=\"val\">gbp/uah</span>\n                                    <span class=\"buy\" name=\"gbp_buy_wsale\">32.000 </span>\n                                    <span class=\"sell\" name=\"gbp_sale_wsale\">33.000 </span>\n                                    <div class=\"shadow\"></div>\n                                </div>\n    \n                                <div class=\"item\">\n                                    <span class=\"val\">pln/uah</span>\n                                    <span class=\"buy\" name=\"pln_buy_wsale\">6.500 </span>\n                                    <span class=\"sell\" name=\"pln_sale_wsale\">6.900 </span>\n                                    <div class=\"shadow\"></div>\n                                </div>\n                            </div>\n                            <div class=\"desc\">\n                                <div class=\"right\">\n                                    <a class=\"btn_yellow\" href=\"#\" id=\"calc\">Калькулятор</a>\n                                </div>\n                                <div class=\"text\">\n                                    <p>Все курсы имеют информативную цель и не являются публичной офертой. \n                                    <br>Чтобы зафиксировать курс, сделайте заказ по телефону <a href=\"tel:0966028040\"><u>096-60-280-40</u></a></p>\n                                </div>\n                            </div>\n                        </div>\n                      </div>\n                     \n                      <div class=\"tabs__content fadeInLeft animated\">\n                        <div class=\"tablo\">\n                                <p class=\"tablo-title\">РОЗНИЦА </p>\n                            <div class=\"bar\">\n                                <div class=\"clear\"></div>\n                                <div class=\"text\">\n                                    <span>Покупка</span>\n                                    <span>Продажа</span>\n                                </div>\n                            </div>\n                            <div class=\"digits\">\n                                <div class=\"item\">\n                                    <span class=\"val\">usd/uah</span>\n                                    <span class=\"buy\" name=\"usd_buy\">27.10 </span>\n                                    <span class=\"sell\" name=\"usd_sale\">27.90 </span>\n                                    <div class=\"shadow\"></div>\n                                </div>\n    \n                                <div class=\"item\">\n                                    <span class=\"val\">eur/uah</span>\n                                    <span class=\"buy\" name=\"eur_buy\">30.00 </span>\n                                    <span class=\"sell\" name=\"eur_sale\">30.80 </span>\n                                    <div class=\"shadow\"></div>\n                                </div>\n    \n                                <div class=\"item\">\n                                    <span class=\"val\">rub/uah</span>\n                                    <span class=\"buy\" name=\"rub_buy\">0.3620 </span>\n                                    <span class=\"sell\" name=\"rub_sale\">0.3770 </span>\n                                    <div class=\"shadow\"></div>\n                                </div>\n    \n                                <div class=\"item\">\n                                    <span class=\"val\">usd/rub</span>\n                                    <span class=\"buy\" name=\"usd_rub_buy\">67.000 </span>\n                                    <span class=\"sell\" name=\"usd_rub_sale\">75.000 </span>\n                                    <div class=\"shadow\"></div>\n                                </div>\n    \n                                <div class=\"item\">\n                                    <span class=\"val\">eur/usd</span>\n                                    <span class=\"buy\">1.100 </span>\n                                    <span class=\"sell\">1.140 </span>\n                                    <div class=\"shadow\"></div>\n                                </div>\n    \n                                <div class=\"item\">\n                                    <span class=\"val\">gbp/uah</span>\n                                    <span class=\"buy\" name=\"gbp_buy\">31.000 </span>\n                                    <span class=\"sell\" name=\"gbp_sale\">33.500 </span>\n                                    <div class=\"shadow\"></div>\n                                </div>\n    \n                                <div class=\"item\">\n                                    <span class=\"val\">pln/uah</span>\n                                    <span class=\"buy\" name=\"pln_buy\">6.500 </span>\n                                    <span class=\"sell\" name=\"pln_sale\">6.900 </span>\n                                    <div class=\"shadow\"></div>\n                                </div>\n                            </div>\n                            <div class=\"desc\">\n                                <div class=\"right\">\n                                    <a class=\"btn_yellow\" href=\"#\" id=\"calc\">Калькулятор</a>\n                                </div>\n                                <div class=\"text\">\n                                    <p>Все курсы имеют информативную цель и не являются публичной офертой. \n                                    <br>Чтобы зафиксировать курс, сделайте заказ по телефону <a href=\"tel:0966028040\"><u>096-60-280-40</u></a></p>\n                                </div>\n                            </div>\n                        </div>\n                      \n                      \n                      \n                      \n                      \n                      </div>\n                    </div><!-- .tabs-->\n                </div>\n               \n            </div> \n            <div class=\"gray\">\n                <div class=\"container\">\n                    <div class=\"article\">\n                        <h3 class=\"gray-title animated\">Обмен валюты в Харькове. Самый выгодный курс в городе!</h3>\n                        <span class=\"hello animated\">Добро пожаловать на \"obmenka.kh.ua\" —<br /> Всегда выгодный и актуальный курс обмена валюты</span>\n                        <div class=\"about\">\n                            <ul class=\"gray-left animated\">\n                                <li>Работая на рынке обмена наличной валюты Харькова уже более 10 лет, мы заслужили себе репутацию надежного партнера благодаря высокому профессионализму сотрудников и руководства, безопасности и высокой скорости проведения операций.</li>\n                                <li>В нашем центре обмена валюты всегда один из самых выгодных курсов обмена валюты.</li>\n                                <li>В нашем центре обмена работает система заказов. Позвонив нам по телефону, Вы можете зафиксировать курс обмена валюты, действительный на данный момент, который мы гарантируем обеспечить в течение часа.</li>\n                            </ul>\n                            <ul class=\"gray-right animated\">\n                                <li>На нашем сайте Вы всегда в режиме он-лайн можете узнать курсы обмена валют на основные мировые валюты и можете быть уверены, что это один из лучших курсов обмена валюты в Харькове, а главное настоящий.</li>\n                                <li>В нашем центре \"obmenka.kh.ua\" Вы можете по выгодным условиям купить и продать евро, доллар, рубль.</li>\n                                <li>Ежедневно к нам обращаются тысячи клиентов города Харькова, которые обращаются с просьбой купить либо обменять валюту различных стран мира.</li>\n                            </ul>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            <div class=\"branch\" id=\"branch\">\n            \t<div class=\"container\">\n            \t\t<div class=\"branch-wrap\">\n            \t\t\t<h2 class=\"branch__title animated\">\n            \t\t\t\tБЛИЖАЙШЕЕ ОТДЕЛЕНИЕ\n            \t\t\t</h2>\n            \t\t\t<div class=\"thumb animated\">\n            \t\t\t    <div class=\"tumb-block df\">\n                \t\t\t    <a href=\"#img1\" class=\"branch-block\">\n                    \t\t\t    <img src=\"img/ph1.jpg\">\n                    \t\t\t    <p class=\"branch-block__text\">\n                    \t\t\t\t\tОдесская.Героев сталинграда 1А.круг троллейбусов\n                    \t\t\t\t</p>\n                    \t\t\t\t<p class=\"branch-block__texts\">\n                    \t\t\t\t\tРежим работы:  пн-сб - с 9:00 до 20:00, вс - с 9:00 до 18:00\n                    \t\t\t\t</p>\n                    \t\t\t  </a>\n                \n                \t\t\t  <a href=\"#img2\"  class=\"branch-block\">\n                \t\t\t     <img src=\"img/ph2.jpg\">\n                \t\t\t     <p class=\"branch-block__text\">\n                \t\t\t\t\tЦентральный рынок Чеботарская 5\n                \t\t\t\t</p>\n                \t\t\t\t<p class=\"branch-block__texts\">\n                    \t\t\t\t\tРежим работы:  пн-сб - с 9:00 до 20:00, вс - с 9:00 до 18:00\n                    \t\t\t\t</p>\n                \t\t\t  </a>\n                \t\t\t  <a href=\"#img3\" class=\"branch-block\">\n                \t\t\t     <img src=\"img/ph3.jpg\">\n                \t\t\t     <p class=\"branch-block__text\">\n                \t\t\t\t\tМайдан Конституции 1.Дворец Труда ,1-й подъезд\n                \t\t\t\t</p>\n                \t\t\t\t<p class=\"branch-block__texts\">\n                    \t\t\t\t\tРежим работы:  пн-сб - с 9:00 до 20:00, вс - с 9:00 до 18:00\n                    \t\t\t\t</p>\n                \t\t\t  </a>\n            \t\t\t    \n            \t\t\t    </div>    \n            \t\t\t  <div class=\"tumb-block df\">\n                \t\t\t   <a href=\"#img4\" class=\"branch-block\">\n                \t\t\t     <img src=\"img/ph4.jpg\">\n                \t\t\t     <p class=\"branch-block__text\">\n                \t\t\t\t\tГероев Труда,6\n                \t\t\t\t</p>\n                \t\t\t\t<p class=\"branch-block__texts\">\n                    \t\t\t\t\tРежим работы:  пн-сб - с 9:00 до 20:00, вс - с 9:00 до 18:00\n                    \t\t\t\t</p>\n                \t\t\t  </a>\n                \t\t\t  <a href=\"#img5\" class=\"branch-block\">\n                \t\t\t     <img src=\"img/ph5.jpg\">\n                \t\t\t     <p class=\"branch-block__text\">\n                \t\t\t\t\tУниверситет Сумской Рынок\n                \t\t\t\t</p>\n                \t\t\t\t<p class=\"branch-block__texts\">\n                    \t\t\t\t\tРежим работы: 24/7\n                    \t\t\t\t</p>\n                \t\t\t  </a>\n                \t\t\t  <a href=\"#img6\" class=\"branch-block\">\n                \t\t\t     <img src=\"img/ph6.jpg\">\n                \t\t\t     <p class=\"branch-block__text\">\n                \t\t\t\t\tРождественская 33\n                \t\t\t\t</p>\n                \t\t\t    <p class=\"branch-block__texts\">\n                    \t\t\t\t\tРежим работы:  пн-вс - с 7:30 до 18:00\n                    \t\t\t\t</p>\t\n                \t\t\t  </a>\n            \t\t\t  </div>\n            \t\t\t \n            \t\t\t</div>\n            \t\t\t<a href=\"#close\" class=\"lightbox\" id=\"img1\">\n            \t\t\t    <img src=\"img/ph1.jpg\">\n            \t\t\t</a>\n            \t\t\t<a href=\"#close\" class=\"lightbox\" id=\"img2\">\n            \t\t\t    <img src=\"img/ph2.jpg\">\n            \t\t\t</a>\n            \t\t\t<a href=\"#close\" class=\"lightbox\" id=\"img3\">\n            \t\t\t    <img src=\"img/ph3.jpg\">\n            \t\t\t</a>\n            \t\t\t<a href=\"#close\" class=\"lightbox\" id=\"img4\">\n            \t\t\t    <img src=\"img/ph4.jpg\">\n            \t\t\t</a>\n            \t\t\t<a href=\"#close\" class=\"lightbox\" id=\"img5\">\n            \t\t\t    <img src=\"img/ph5.jpg\">\n            \t\t\t</a>\n            \t\t\t<a href=\"#close\" class=\"lightbox\" id=\"img6\">\n            \t\t\t    <img src=\"img/ph6.jpg\">\n            \t\t\t</a>\n            \t\t</div>\n            \t</div>\n            </div>\n            <div class=\"request \">\n            \t<h2 class=\"request-title animated\">\n            \t\tЗакажите обмен валют прямо сейчас\n            \t</h2>\n<form action= \"send.php\" class=\"form\" method= \"POST\"> \n \n <input type=\"text\" name=\"name\" required placeholder=\"Введите имя\"  class=\"form-control form__field\">\n        <input type=\"text\" name=\"email\" required placeholder=\"Введите E-mail\"  class=\"form-control form__field\">\n        <input type=\"text\" name=\"tel\" required placeholder=\"Введите телефон\"  class=\"form-control form__field\">\n        <select name=\"hero\" id=\"selectlocation\" class=\"form-control\">\n          <option value=\"Выберите отдел\" >Выберите отдел</option>\n    <option value=\"Майдан Конституции 1.Дворец Труда ,1-й подъезд\">Майдан Конституции 1.Дворец Труда ,1-й подъезд</option>\n    <option value=\"Центральный рынок Чеботарская 5\">центральный рынок Чеботарская 5</option>\n    <option value=\"Героев Труда,6\">Героев Труда,6</option>\n    <option value=\"Университет .Сумской Рынок\"> Университет .Сумской Рынок</option>\n     <option value=\"Одесская.Героев сталинграда 1А.круг троллейбусов\">Одесская.Героев сталинграда 1А.круг троллейбусов</option>\n    <option value=\"Рождественская 33\">Рождественская 33</option>\n    \n        </select>\n \n<input class=\"btn-primary \" type= \"submit\" value= \"Отправить\"> \n\n</form>\n            </div>\n            <!-- POPUP -->\n            <div id=\"dialog_holder\" class=\"dialog_holder\" style=\"display:none\">\n                <div class=\"popup make_order\">\n                    <a class=\"close\" href=\"#\" id=\"close_popup\"></a>\n                    <h2>Калькулятор обмена валюты</h2>\n                    <p>Вы можете рассчитать точную сумму при обмене валюты на текущий момент</p>\n                    <div class=\"form_exchange\">\n                        <div class=\"fields\">\n                            <div class=\"item\">\n                                <h3>Я хочу:</h3>\n                                <select name=\"operation\">\n                                    <option selected=\"selected\" value=\"change\">Поменять</option>\n                                    <option value=\"buy\">Купить</option>\n                                </select>\n                            </div>\n                            <div class=\"item\">\n                                <h3>Валюту:</h3>\n                                <select name=\"input\">\n                                        <option selected=\"selected\" value=\"UAH\">UAH Гривна</option>\n                                        <option value=\"USD\">USD Американский доллар</option>\n                                        <option value=\"RUB\">RUB Рубль</option>\n                                        <option value=\"EUR\">EURO Евро</option>\n                                </select>\n                            </div>\n                            <div class=\"item\"> \n                              <h3>В количестве:</h3>\n                              <input name=\"summ\" type=\"text\" id=\"summ\">\n                              <span id=\"warning_summ\" style=\"color:Red;display:none;\">Укажите сумму</span>\n                            </div>\n                            <div class=\"item\">\n                                <h3 name=\"type_money\">На:</h3>\n                                <select name=\"out\">\n                                    <option value=\"USD\">USD Американский доллар</option>\n                                    <option value=\"RUB\">RUB Рубль</option>\n                                    <option value=\"EUR\">EURO Евро</option>\n                                    <option value=\"UAH\">UAH Гривна</option>\n                                </select>\n                            </div>\n                            <div id=\"\" class=\"actions\">\n                                <input type=\"submit\" name=\"send\" id=\"send\" class=\"btn_yellow\" value=\"Посчитать\">\n                                <br><span id=\"result\" class=\"ConverterResult\" name=\"result\"></span>\n                            </div>\t\t\n                        </div>  \n                    </div>\n                </div>\n                <div class=\"dialog_overlay\" id=\"dialog_overlay\"></div>\n            </div>\n            \n            <!-- POPUP -->\n            <footer>\n                <div class=\"right\"><!--LiveInternet counter--><script type=\"text/javascript\">document.write(\"<img src='//counter.yadro.ru/hit?t44.5;r\" + escape(document.referrer) + ((typeof (screen) == \"undefined\") ? \"\" : \";s\" + screen.width + \"*\" + screen.height + \"*\" + (screen.colorDepth ? screen.colorDepth : screen.pixelDepth)) + \";u\" + escape(document.URL) + \";\" + Math.random() + \"' border=0 width=31 height=31 alt='' title='LiveInternet'>\")</script><!--/LiveInternet--></div>\n                <span>© obmenka.kh.ua, 2015 - 2020</span>\n            </footer>\n        </div>\n        <script src=\"js/libs/jquery-2.1.1.min.js\"></script>\n        <script src=\"js/main.js\"></script>\n    </body>\n</html>";


            using (WebClient client = new WebClient()) // WebClient class inherits IDisposable
            {
                // Or you can get the file content without saving it
                doc = client.DownloadString("http://obmenka.kh.ua/");
            }

            _elements = new HtmlParser().ParseDocument(doc).All.Where(m => m.LocalName == "span").ToList();

            return new List<CurrencyItem>
            {
                GetItemByCurrencyType(ObmenkaRetail, CurrencyTypes.USD, "usd_buy", "usd_sale"),
                GetItemByCurrencyType(ObmenkaWholesale, CurrencyTypes.USD, "usd_buy_wsale", "usd_sale_wsale"),
                
                GetItemByCurrencyType(ObmenkaRetail, CurrencyTypes.EUR, "eur_buy", "eur_sale"),
                GetItemByCurrencyType(ObmenkaWholesale, CurrencyTypes.EUR, "eur_buy_wsale", "eur_sale_wsale"),
                
                GetItemByCurrencyType(ObmenkaRetail, CurrencyTypes.GBP, "gbp_buy", "gbp_sale"),
                GetItemByCurrencyType(ObmenkaWholesale, CurrencyTypes.GBP, "gbp_buy_wsale", "gbp_sale_wsale"),
            };


        }

        private CurrencyItem GetItemByCurrencyType(string name, string type, string buyId, string sellId)
            =>
                new CurrencyItem(name)
                {
                    Buy = GetData("buy", buyId),
                    Sell = GetData("sell", sellId),
                    Type = type
                };

        private decimal GetData(string className, string name) =>
            Convert.ToDecimal(
                _elements.FirstOrDefault(s => s.ClassName == className && s.OuterHtml.Contains($"\"{name}\""))?.Text()
                );

    }
}
